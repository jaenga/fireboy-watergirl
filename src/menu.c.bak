#include "menu.h"
#include "console.h"
#include "input.h"
#include "ranking.h"
#include <ctype.h>

// ë©”ë‰´ í™”ë©´ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
static void draw_main_menu(int selected) {
    const int menu_count = 4;
    
    // ì œëª© - ì¤‘ì•™ì •ë ¬
    console_set_cursor_position(0, 2);
    console_set_color(COLOR_RED, COLOR_BLACK);
    console_set_attribute(ATTR_BOLD);
    printf("          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆâ–ˆ\n");
    printf("          â–ˆâ–ˆ      â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ \n");
    printf("          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ  \n");
    printf("          â–ˆâ–ˆ      â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ   \n");
    printf("          â–ˆâ–ˆ      â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆ   \n");
    console_reset_color();
    
    console_set_cursor_position(0, 10);
    console_set_color(COLOR_CYAN, COLOR_BLACK);
    console_set_attribute(ATTR_BOLD);
    printf("       â–ˆâ–ˆ     â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ\n");
    printf("       â–ˆâ–ˆ     â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ       â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ\n");
    printf("       â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ\n");
    printf("       â–ˆâ–ˆ â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆ      â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ\n");
    printf("        â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ   â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n");
    console_reset_color();
    
    // ë©”ë‰´ í•­ëª©ë“¤ - ì¤‘ì•™ì •ë ¬
    const char* menu_items[] = {
        "ğŸ® ê²Œì„í•˜ê¸°",
        "ğŸ“– ê²Œì„ì„¤ëª…", 
        "ğŸ† ë­í‚¹ë³´ê¸°",
        "ì¢…ë£Œ"
    };
    
    for (int i = 0; i < menu_count; i++) {
        console_set_cursor_position(33, 19 + i * 2);
        
        if (i == selected) {
            console_set_color(COLOR_BLACK, COLOR_YELLOW);
            console_set_attribute(ATTR_BOLD);
            printf("  â–¶ %s â—€  ", menu_items[i]);
        } else {
            console_set_color(COLOR_WHITE, COLOR_BLACK);
            printf("    %s    ", menu_items[i]);
        }
        console_reset_color();
    }
    
    // ì¡°ì‘ ì•ˆë‚´ - ì¤‘ì•™ì •ë ¬
    console_set_cursor_position(0, 28);
    console_set_color(COLOR_GREEN, COLOR_BLACK);
    printf("                  â†‘â†“ ë˜ëŠ” W/S: ë©”ë‰´ ì´ë™ | Enter: ì„ íƒ\n");
    console_reset_color();
    
    fflush(stdout);
}

// ë©”ì¸ ë©”ë‰´ í‘œì‹œ
MenuResult menu_show_main(void) {
    MenuResult result;
    result.type = MENU_EXIT;
    result.player_name[0] = '\0';
    
    int selected = 0;
    const int menu_count = 4;
    int last_selected = -1;
    
    // ì²« í™”ë©´ ê·¸ë¦¬ê¸°
    console_clear();
    draw_main_menu(selected);
    
    while (true) {
        // ì…ë ¥ ì²˜ë¦¬
        input_update();
        PlayerInput player_input = input_get_player_input();
        
        bool needs_redraw = false;
        
        if (player_input.fireboy.up || player_input.watergirl.up) {
            selected = (selected - 1 + menu_count) % menu_count;
            needs_redraw = true;
            #ifdef PLATFORM_WINDOWS
            Sleep(150);
            #else
            usleep(150000);
            #endif
        } else if (player_input.fireboy.down || player_input.watergirl.down) {
            selected = (selected + 1) % menu_count;
            needs_redraw = true;
            #ifdef PLATFORM_WINDOWS
            Sleep(150);
            #else
            usleep(150000);
            #endif
        } else if (player_input.fireboy.enter || player_input.watergirl.enter) {
            // ì„ íƒ
            switch (selected) {
                case 0: // ê²Œì„í•˜ê¸°
                    if (menu_get_player_name(result.player_name, MAX_NAME_LENGTH)) {
                        result.type = MENU_GAME;
                        return result;
                    }
                    // ì´ë¦„ ì…ë ¥ í›„ ë©”ë‰´ë¡œ ëŒì•„ì˜¤ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    console_clear();
                    draw_main_menu(selected);
                    break;
                case 1: // ê²Œì„ì„¤ëª…
                    // Enter í‚¤ ì…ë ¥ ëŒ€ê¸° (ì—°ì† ì…ë ¥ ë°©ì§€)
                    #ifdef PLATFORM_WINDOWS
                    Sleep(200);
                    #else
                    usleep(200000);
                    #endif
                    
                    menu_show_instructions();
                    
                    // ê²Œì„ì„¤ëª… í›„ ë©”ë‰´ë¡œ ëŒì•„ì˜¤ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    console_clear();
                    draw_main_menu(selected);
                    break;
                case 2: // ë­í‚¹ë³´ê¸°
                    {
                        // Enter í‚¤ ì…ë ¥ ëŒ€ê¸° (ì—°ì† ì…ë ¥ ë°©ì§€)
                        #ifdef PLATFORM_WINDOWS
                        Sleep(200);
                        #else
                        usleep(200000);
                        #endif
                        
                        RankingSystem ranking;
                        ranking_load(&ranking);
                        ranking_display(&ranking);
                        
                        // ì…ë ¥ ë²„í¼ ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
                        #ifdef PLATFORM_WINDOWS
                        Sleep(200);
                        #else
                        usleep(200000);
                        #endif
                        
                        // ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥¼ ë•Œê¹Œì§€ ëŒ€ê¸°
                        while (!input_is_quit_requested()) {
                            input_update();
                            PlayerInput inp = input_get_player_input();
                            if (inp.fireboy.enter || inp.watergirl.enter || inp.fireboy.escape) {
                                break;
                            }
                            
                            #ifdef PLATFORM_WINDOWS
                            Sleep(50);
                            #else
                            usleep(50000);
                            #endif
                        }
                        
                        // ë­í‚¹ í›„ ë©”ë‰´ë¡œ ëŒì•„ì˜¤ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                        console_clear();
                        draw_main_menu(selected);
                    }
                    break;
                case 3: // ì¢…ë£Œ
                    result.type = MENU_EXIT;
                    return result;
            }
        } else if (player_input.fireboy.escape || input_is_quit_requested()) {
            result.type = MENU_EXIT;
            return result;
        }
        
        // ì„ íƒì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        if (needs_redraw && selected != last_selected) {
            draw_main_menu(selected);
            last_selected = selected;
        }
        
        #ifdef PLATFORM_WINDOWS
        Sleep(50);
        #else
        usleep(50000);
        #endif
    }
}

// ê²Œì„ ì„¤ëª… í‘œì‹œ
void menu_show_instructions(void) {
    console_clear();
    console_set_cursor_position(0, 2);
    
    console_set_color(COLOR_YELLOW, COLOR_BLACK);
    console_set_attribute(ATTR_BOLD);
    printf("                              ğŸ“– ê²Œì„ ì„¤ëª… ğŸ“–\n\n");
    console_reset_color();
    
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
    console_reset_color();
    
    console_set_color(COLOR_RED, COLOR_BLACK);
    console_set_attribute(ATTR_BOLD);
    printf("     ğŸ”¥ Fireboy ");
    console_reset_color();
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("ì™€ ");
    console_set_color(COLOR_CYAN, COLOR_BLACK);
    console_set_attribute(ATTR_BOLD);
    printf("ğŸ’§ Watergirl ");
    console_reset_color();
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("ì„ ì¡°ì‘í•˜ì—¬ í•¨ê»˜ íƒˆì¶œí•˜ì„¸ìš”!\n\n");
    
    printf("     ã€ ì¡°ì‘ ë°©ë²• ã€‘\n");
    console_set_color(COLOR_RED, COLOR_BLACK);
    printf("       â€¢ Fireboy:   â† â†’ ì´ë™, â†‘ ì í”„\n");
    console_reset_color();
    console_set_color(COLOR_CYAN, COLOR_BLACK);
    printf("       â€¢ Watergirl: A D ì´ë™, W ì í”„\n\n");
    console_reset_color();
    
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("     ã€ ê²Œì„ ê·œì¹™ ã€‘\n");
    printf("       â€¢ ë‘ ìºë¦­í„°ë¥¼ ëª¨ë‘ ì¶œêµ¬ê¹Œì§€ ì´ë™ì‹œí‚¤ì„¸ìš”.\n");
    printf("       â€¢ ");
    console_set_color(COLOR_RED, COLOR_BLACK);
    printf("ğŸ”¥ Fireboy");
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("ëŠ” ë¬¼ì— ë‹¿ìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤!\n");
    printf("       â€¢ ");
    console_set_color(COLOR_CYAN, COLOR_BLACK);
    printf("ğŸ’§ Watergirl");
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("ëŠ” ë¶ˆì— ë‹¿ìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤!\n");
    printf("       â€¢ ì´ˆë¡ìƒ‰ ë…ì€ ë‘˜ ë‹¤ í”¼í•´ì•¼ í•©ë‹ˆë‹¤.\n");
    printf("       â€¢ ë¹¨ê°„ ë³´ì„ì€ Fireboy, íŒŒë€ ë³´ì„ì€ Watergirlì´ ìˆ˜ì§‘í•˜ì„¸ìš”.\n");
    printf("       â€¢ ìŠ¤ìœ„ì¹˜ë¥¼ ë°Ÿìœ¼ë©´ ë¬¸ì´ ì—´ë¦½ë‹ˆë‹¤.\n");
    printf("       â€¢ ìƒìë¥¼ ë°€ì–´ì„œ í¼ì¦ì„ í’€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n");
    
    printf("     ã€ ëª©í‘œ ã€‘\n");
    printf("       â€¢ ê°€ëŠ¥í•œ í•œ ë¹¨ë¦¬ í´ë¦¬ì–´í•˜ì—¬ ë­í‚¹ì— ë“±ë¡í•˜ì„¸ìš”!\n");
    printf("       â€¢ ì‚¬ë§ íšŸìˆ˜ê°€ ì ì„ìˆ˜ë¡ ì¢‹ìŠµë‹ˆë‹¤.\n\n");
    
    printf("     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
    console_reset_color();
    
    // ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
    console_set_cursor_position(0, 26);
    console_set_color(COLOR_BLACK, COLOR_GREEN);
    console_set_attribute(ATTR_BOLD);
    printf("                         [ ESC: ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸° ]                        ");
    console_reset_color();
    
    
    console_set_cursor_position(0, 28);
    console_set_color(COLOR_YELLOW, COLOR_BLACK);
    printf("                       ë˜ëŠ” Enterë¥¼ ëˆŒëŸ¬ ê³„ì†í•˜ì„¸ìš”");
    console_reset_color();
    
    fflush(stdout);
    
    // ì…ë ¥ ë²„í¼ ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
    #ifdef PLATFORM_WINDOWS
    Sleep(200);
    #else
    usleep(200000);
    #endif
    
    // ESC ë˜ëŠ” Enter ëˆ„ë¥¼ ë•Œê¹Œì§€ ëŒ€ê¸°
    while (!input_is_quit_requested()) {
        input_update();
        PlayerInput inp = input_get_player_input();
        
        if (inp.fireboy.enter || inp.watergirl.enter || inp.fireboy.escape) {
            break;
        }
        
        #ifdef PLATFORM_WINDOWS
        Sleep(50);
        #else
        usleep(50000);
        #endif
    }
}

// í”Œë ˆì´ì–´ ì´ë¦„ ì…ë ¥
bool menu_get_player_name(char* name, int max_length) {
    console_clear();
    console_set_cursor_position(0, 10);
    
    console_set_color(COLOR_YELLOW, COLOR_BLACK);
    console_set_attribute(ATTR_BOLD);
    printf("                         í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”\n\n");
    console_reset_color();
    
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("                      (ìµœëŒ€ %dì, Enterë¡œ í™•ì¸)\n\n", max_length - 1);
    printf("                      ì´ë¦„: ");
    console_reset_color();
    
    console_show_cursor();
    fflush(stdout);
    
    // í„°ë¯¸ë„ì„ ì¼ë°˜ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
    input_enable_line_mode();
    
    // ì´ë¦„ ì…ë ¥ ë°›ê¸°
    if (fgets(name, max_length, stdin) != NULL) {
        // raw ëª¨ë“œë¡œ ë³µê·€
        input_disable_line_mode();
        // ê°œí–‰ ë¬¸ì ì œê±°
        size_t len = strlen(name);
        if (len > 0 && name[len - 1] == '\n') {
            name[len - 1] = '\0';
            len--;
        }
        
        // ê³µë°± ì œê±°
        while (len > 0 && isspace((unsigned char)name[len - 1])) {
            name[len - 1] = '\0';
            len--;
        }
        
        // ë¹ˆ ì´ë¦„ ì²´í¬
        if (len == 0) {
            console_hide_cursor();
            console_set_cursor_position(0, 16);
            console_set_color(COLOR_RED, COLOR_BLACK);
            printf("                      ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!\n");
            printf("                 Enter ë˜ëŠ” ESC: ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°");
            console_reset_color();
            fflush(stdout);
            
            // ì…ë ¥ ë²„í¼ ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
            #ifdef PLATFORM_WINDOWS
            Sleep(200);
            #else
            usleep(200000);
            #endif
            
            while (!input_is_quit_requested()) {
                input_update();
                PlayerInput inp = input_get_player_input();
                if (inp.fireboy.enter || inp.watergirl.enter || inp.fireboy.escape) {
                    break;
                }
                
                #ifdef PLATFORM_WINDOWS
                Sleep(50);
                #else
                usleep(50000);
                #endif
            }
            return false;
        }
        
        console_hide_cursor();
        return true;
    }
    
    // raw ëª¨ë“œë¡œ ë³µê·€ (fgets ì‹¤íŒ¨ ì‹œ)
    input_disable_line_mode();
    console_hide_cursor();
    return false;
}

// ê²Œì„ ì¢…ë£Œ í™”ë©´
void menu_show_game_over(const char* player_name, float time, int death_count, bool is_victory) {
    console_clear();
    console_set_cursor_position(0, 8);
    
    if (is_victory) {
        console_set_color(COLOR_YELLOW, COLOR_BLACK);
        console_set_attribute(ATTR_BOLD);
        printf("                             ğŸ‰ í´ë¦¬ì–´! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰\n\n");
        console_reset_color();
    } else {
        console_set_color(COLOR_RED, COLOR_BLACK);
        console_set_attribute(ATTR_BOLD);
        printf("                                  ê²Œì„ ì¢…ë£Œ\n\n");
        console_reset_color();
    }
    
    console_set_color(COLOR_WHITE, COLOR_BLACK);
    printf("                      í”Œë ˆì´ì–´: %s\n", player_name);
    
    int minutes = (int)(time / 60);
    int seconds = (int)(time) % 60;
    printf("                      í´ë¦¬ì–´ ì‹œê°„: %dë¶„ %dì´ˆ\n", minutes, seconds);
    printf("                      ì‚¬ë§ íšŸìˆ˜: %díšŒ\n\n", death_count);
    console_reset_color();
    
    if (is_victory) {
        // ë­í‚¹ ì‹œìŠ¤í…œì— ì¶”ê°€
        RankingSystem ranking;
        ranking_load(&ranking);
        
        if (ranking_add_entry(&ranking, player_name, time, death_count)) {
            console_set_color(COLOR_GREEN, COLOR_BLACK);
            console_set_attribute(ATTR_BOLD);
            printf("                      ğŸ† ë­í‚¹ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ†\n\n");
            console_reset_color();
            ranking_save(&ranking);
        }
    }
    
    console_set_color(COLOR_GREEN, COLOR_BLACK);
    printf("                 Enter ë˜ëŠ” ESC: ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°\n");
    console_reset_color();
    
    fflush(stdout);
    
    // ì…ë ¥ ë²„í¼ ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸°
    #ifdef PLATFORM_WINDOWS
    Sleep(200);
    #else
    usleep(200000);
    #endif
    
    // ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥¼ ë•Œê¹Œì§€ ëŒ€ê¸°
    while (!input_is_quit_requested()) {
        input_update();
        PlayerInput inp = input_get_player_input();
        if (inp.fireboy.enter || inp.watergirl.enter || inp.fireboy.escape) {
            break;
        }
        
        #ifdef PLATFORM_WINDOWS
        Sleep(50);
        #else
        usleep(50000);
        #endif
    }
}

